#!/usr/bin/env node

const ntpl = require('commander'),
    Mustache = require('mustache'),
    utils = require('./utils/utility'),
    parser = require('./utils/parser'),
    supportList = ['yaml', 'yml']

ntpl
  .version('0.3.1', '-v, --version')
  .option('-c, --components [value]', 'kubernetes components', componentReader, [])
  .option('-p, --parameters [value]', 'parameters file (yaml|yml)', parameterReader, [])

ntpl
  .command('compile')
  .description('Compile kubernetes templates.')
  .action(() => {
    kubeCompile()
  })

ntpl
  .command('validate')
  .description('Validate kubernetes templates.')
  .action(() => {
    kubeCompile()
    kubeValidate(ntpl.components)
  })

ntpl
  .command('apply')
  .description('Apply templates into kubernetes.')
  .action(() => {
    kubeCompile()
    kubeApply(ntpl.components)
  })

ntpl
  .command('delete')
  .description('Delete templates from kubernetes')
  .action(() => {
    kubeCompile()
    kubeDelete(ntpl.components)
  })

ntpl
  .parse(process.argv)

function parameterReader(filePath, fileList) {
  if (parser.isInSupportList(filePath, supportList)) {
    fileList.push(filePath)
  }
  return fileList
}

function componentReader(component, componentsList){
  componentsList.push(component)
  return componentsList
}

function kubeCompile() {
  const buildPath = `_build`,
        params = parser.parameterBuilder(ntpl.parameters),
        components = ntpl.components

  // Clean build folder
  utils.rmdir(buildPath)
  components.map(component => utils.mkdir(`${process.cwd()}/${buildPath}/${component}`))

  // Compile Each Component
  components.map(component => {
    const componentPath = `${process.cwd()}/templates/${component}`
    const files = utils.readdir(componentPath)
    files.map(file => {
      const fileContent = utils.readfile(file)
      utils.appendFile(file.replace(/templates/, buildPath), Mustache.render(fileContent, params))
    })
  })

}

function kubeValidate(components) {
  components.map(component => {
    const buildFolderPath = `${process.cwd()}/_build/${component}`
    const files = utils.readdir(buildFolderPath)
    files.map(file => utils.exec(`kubectl apply --validate --dry-run -f ${file}`))
  })
}

function kubeApply(components) {
  components.map(component => {
    const buildFolderPath = `${process.cwd()}/_build/${component}`
    const files = utils.readdir(buildFolderPath)
    files.map(file => utils.exec(`kubectl apply -f ${file}`))
  })
}

function kubeDelete(components) {
  components.map(component => {
    const buildFolderPath = `${process.cwd()}/_build/${component}`
    const files = utils.readdir(buildFolderPath)
    files.map(file => utils.exec(`kubectl delete -f ${file}`))
  })
}
